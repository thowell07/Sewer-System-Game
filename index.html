<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dalton's Underground Highway</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @keyframes bounce-slight {
            0%, 100% { transform: translateY(-5%); }
            50% { transform: translateY(5%); }
        }
        .animate-bounce-slight {
            animation: bounce-slight 2s infinite ease-in-out;
        }
    </style>
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- Icons as Components ---
        const Play = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
        );
        const RotateCw = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 12"/><path d="M21 5v7h-7"/></svg>
        );
        const CheckCircle = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
        );
        const ArrowRight = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
        );
        const Home = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        );
        const Factory = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M2 20a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8l-7 5V8l-7 5V4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><path d="M17 18h1"/><path d="M12 18h1"/><path d="M7 18h1"/></svg>
        );
        const MapIcon = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></svg>
        );
        const Droplet = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 2.69l5.74 5.88a6 6 0 0 1-1.97 9.43H8.23a6 6 0 0 1-1.97-9.43l5.74-5.88z"/></svg>
        );
        const Settings = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
        );

        // --- UI Components ---

        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-xl shadow-lg border-2 border-blue-900 overflow-hidden ${className}`}>
                {children}
            </div>
        );

        const Button = ({ onClick, children, className = "", disabled = false }) => (
            <button
                onClick={onClick}
                disabled={disabled}
                className={`px-6 py-3 rounded-full font-bold text-lg transition-all transform active:scale-95 flex items-center gap-2
                ${disabled 
                    ? 'bg-gray-300 text-gray-500 cursor-not-allowed' 
                    : 'bg-yellow-400 hover:bg-yellow-300 text-blue-900 border-b-4 border-yellow-600 active:border-b-0 active:translate-y-1 shadow-md'
                } ${className}`}
            >
                {children}
            </button>
        );

        // --- Pipe Logic & Data ---

        const LEVELS = [
        {
            id: 1,
            title: "The House Connection",
            instruction: "Connect the Bathroom to the Street Pipe.",
            gridSize: 3,
            start: { r: 0, c: 0 }, 
            end: { r: 2, c: 2 },   
            layout: [
            { type: 'start', rotation: 0 }, { type: 'pipe', rotation: 90, shape: 'straight' }, { type: 'empty' },
            { type: 'empty' }, { type: 'pipe', rotation: 0, shape: 'corner' }, { type: 'pipe', rotation: 90, shape: 'straight' },
            { type: 'empty' }, { type: 'empty' }, { type: 'end', rotation: 0 }
            ],
            solutionPath: [0, 1, 4, 5, 8]
        },
        {
            id: 2,
            title: "The Neighborhood Junction",
            instruction: "Merge the waste from two houses onto the Main Highway.",
            gridSize: 4,
            layout: [
            { type: 'start', rotation: 0, label: 'House 1' }, { type: 'pipe', rotation: 90, shape: 'straight' }, { type: 'pipe', rotation: 180, shape: 'corner' }, { type: 'empty' },
            { type: 'empty' }, { type: 'empty' }, { type: 'pipe', rotation: 0, shape: 'straight' }, { type: 'empty' },
            { type: 'start', rotation: 0, label: 'House 2' }, { type: 'pipe', rotation: 0, shape: 'straight' }, { type: 'pipe', rotation: 270, shape: 't-shape' }, { type: 'pipe', rotation: 0, shape: 'straight' },
            { type: 'empty' }, { type: 'empty' }, { type: 'pipe', rotation: 0, shape: 'straight' }, { type: 'end', rotation: 0 }
            ]
        },
        {
            id: 3,
            title: "The Treatment Plant",
            instruction: "Guide the dirty water into the cleaning tanks.",
            gridSize: 4,
            layout: [
            { type: 'start', rotation: 0 }, { type: 'pipe', rotation: 0, shape: 'straight' }, { type: 'pipe', rotation: 90, shape: 'corner' }, { type: 'empty' },
            { type: 'empty' }, { type: 'pipe', rotation: 0, shape: 'corner' }, { type: 'pipe', rotation: 180, shape: 't-shape' }, { type: 'pipe', rotation: 180, shape: 'corner' },
            { type: 'empty' }, { type: 'pipe', rotation: 0, shape: 'straight' }, { type: 'empty' }, { type: 'pipe', rotation: 0, shape: 'straight' },
            { type: 'empty' }, { type: 'end', rotation: 0 }, { type: 'empty' }, { type: 'end', rotation: 0 }
            ]
        }
        ];

        // --- Main Game Component ---

        function SewerSystemGame() {
            const [currentLevelIndex, setCurrentLevelIndex] = useState(0);
            const [gameState, setGameState] = useState('intro');
            const [grid, setGrid] = useState([]);
            const [flowProgress, setFlowProgress] = useState(0);

            useEffect(() => {
                if (gameState === 'intro' || gameState === 'complete') return;
                
                const levelData = LEVELS[currentLevelIndex];
                const initialGrid = levelData.layout.map((cell, index) => ({
                ...cell,
                id: index,
                rotation: cell.type === 'pipe' ? Math.floor(Math.random() * 4) * 90 : cell.rotation
                }));
                setGrid(initialGrid);
                setFlowProgress(0);
            }, [currentLevelIndex, gameState]);

            const handleTileClick = (index) => {
                if (gameState === 'flowing' || gameState === 'success') return;

                setGrid(prev => {
                const newGrid = [...prev];
                const cell = newGrid[index];
                if (cell.type === 'pipe') {
                    newGrid[index] = { ...cell, rotation: (cell.rotation + 90) % 360 };
                }
                return newGrid;
                });
            };

            const checkSystem = () => {
                let isCorrect = false;
                const g = grid;

                if (currentLevelIndex === 0) {
                    if (g[1].rotation === 90 && g[4].rotation === 0 && g[5].rotation === 0) isCorrect = true;
                } 
                else if (currentLevelIndex === 1) {
                    if (g[1].rotation === 90 && g[2].rotation === 180 && g[6].rotation === 0 && g[9].rotation === 0 && g[10].rotation === 270 && g[11].rotation === 0 && g[14].rotation === 0) isCorrect = true;
                }
                else {
                    if (g[6].rotation === 180) isCorrect = true; 
                }

                if (isCorrect) {
                startFlow();
                } else {
                    // Logic for shake could go here
                }
            };

            const startFlow = () => {
                setGameState('flowing');
                const interval = setInterval(() => {
                setFlowProgress(prev => {
                    if (prev >= 100) {
                    clearInterval(interval);
                    setGameState('success');
                    return 100;
                    }
                    return prev + 2; 
                });
                }, 50);
            };

            const nextLevel = () => {
                if (currentLevelIndex < LEVELS.length - 1) {
                setCurrentLevelIndex(prev => prev + 1);
                setGameState('playing');
                } else {
                setGameState('complete');
                }
            };

            const renderPipe = (cell) => {
                const color = gameState === 'flowing' || gameState === 'success' ? '#3B82F6' : '#9CA3AF'; 
                const flowColor = '#60A5FA'; 
                
                const shapes = {
                straight: (
                    <g>
                    <rect x="15" y="0" width="20" height="50" fill={color} />
                    <rect x="20" y="0" width="10" height="50" fill={flowProgress > 0 ? flowColor : 'transparent'} opacity={flowProgress/100} />
                    </g>
                ),
                corner: (
                    <g>
                    <path d="M25 0 V25 H50" stroke={color} strokeWidth="20" fill="none" />
                    <path d="M25 0 V25 H50" stroke={flowProgress > 0 ? flowColor : 'transparent'} strokeWidth="10" fill="none" opacity={flowProgress/100} />
                    </g>
                ),
                't-shape': (
                    <g>
                    <path d="M0 25 H50 M25 25 V50" stroke={color} strokeWidth="20" fill="none" />
                    <path d="M0 25 H50 M25 25 V50" stroke={flowProgress > 0 ? flowColor : 'transparent'} strokeWidth="10" fill="none" opacity={flowProgress/100} />
                    </g>
                ),
                cross: (
                    <g>
                    <path d="M0 25 H50 M25 0 V50" stroke={color} strokeWidth="20" fill="none" />
                    <path d="M0 25 H50 M25 0 V50" stroke={flowProgress > 0 ? flowColor : 'transparent'} strokeWidth="10" fill="none" opacity={flowProgress/100} />
                    </g>
                )
                };

                return (
                <div 
                    className="w-full h-full transition-transform duration-300 ease-in-out" 
                    style={{ transform: `rotate(${cell.rotation}deg)` }}
                >
                    <svg viewBox="0 0 50 50" className="w-full h-full drop-shadow-sm">
                    {shapes[cell.shape] || shapes['straight']}
                    </svg>
                </div>
                );
            };

            if (gameState === 'intro') {
                return (
                <div className="min-h-screen bg-blue-50 flex flex-col items-center justify-center p-4 font-sans">
                    <Card className="max-w-md w-full p-8 text-center space-y-6">
                    <div className="w-24 h-24 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <MapIcon className="text-blue-600 w-12 h-12" size={48} />
                    </div>
                    <h1 className="text-3xl font-extrabold text-blue-900">Dalton's Underground Highway</h1>
                    <p className="text-gray-600 text-lg">
                        Connect the pipes to help the city! 
                        Waste needs to travel from the <strong>House</strong> to the <strong>Treatment Plant</strong>.
                    </p>
                    <p className="text-sm bg-yellow-100 p-3 rounded-lg text-yellow-800 font-medium border border-yellow-200">
                        Build the System. Start the Flow.
                    </p>
                    <div className="pt-4 flex justify-center">
                        <Button onClick={() => setGameState('playing')}>
                        <Play size={24} fill="currentColor" />
                        START SYSTEM
                        </Button>
                    </div>
                    </Card>
                </div>
                );
            }

            if (gameState === 'complete') {
                return (
                <div className="min-h-screen bg-green-50 flex flex-col items-center justify-center p-4">
                    <Card className="max-w-md w-full p-8 text-center space-y-6">
                    <div className="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mx-auto">
                        <CheckCircle className="text-green-600 w-16 h-16" size={64} />
                    </div>
                    <h1 className="text-3xl font-extrabold text-green-900">System Fully Operational!</h1>
                    <p className="text-gray-700 text-lg">
                        You built a great network, Dalton! All the waste is now moving safely to the plant to be cleaned.
                    </p>
                    <Button onClick={() => { setCurrentLevelIndex(0); setGameState('intro'); }}>
                        <RotateCw size={24} />
                        Play Again
                    </Button>
                    </Card>
                </div>
                );
            }

            const currentLevel = LEVELS[currentLevelIndex];

            return (
                <div className="min-h-screen bg-slate-100 flex flex-col items-center p-4">
                <div className="w-full max-w-2xl flex justify-between items-center mb-6 bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                    <div>
                    <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2">
                        <Settings className="text-slate-400" size={20} />
                        Level {currentLevelIndex + 1}: {currentLevel.title}
                    </h2>
                    <p className="text-slate-500 text-sm">{currentLevel.instruction}</p>
                    </div>
                    <div className="flex gap-2">
                    <div className={`h-3 w-3 rounded-full ${gameState === 'flowing' || gameState === 'success' ? 'bg-green-500 animate-pulse' : 'bg-red-400'}`}></div>
                    <span className="text-xs font-bold text-slate-400 uppercase tracking-wider">
                        {gameState === 'playing' ? 'SYSTEM OFF' : 'SYSTEM ON'}
                    </span>
                    </div>
                </div>

                <Card className="p-6 bg-slate-800 border-slate-700 relative">
                    <div 
                    className="grid gap-1 bg-slate-900 p-2 rounded-lg border-4 border-slate-700 shadow-inner"
                    style={{ 
                        gridTemplateColumns: `repeat(${currentLevel.gridSize}, minmax(0, 1fr))`,
                        width: '100%',
                        maxWidth: '500px'
                    }}
                    >
                    {grid.map((cell, idx) => (
                        <div 
                        key={idx}
                        onClick={() => handleTileClick(idx)}
                        className={`
                            aspect-square rounded-md flex items-center justify-center relative
                            ${cell.type === 'empty' ? 'bg-slate-800/50' : 'bg-slate-700 cursor-pointer hover:bg-slate-600'}
                            ${cell.type === 'start' || cell.type === 'end' ? 'bg-transparent cursor-default hover:bg-transparent' : ''}
                            transition-colors
                        `}
                        >
                        {cell.type === 'start' && (
                            <div className="flex flex-col items-center justify-center text-white z-10 animate-bounce-slight">
                            <div className="bg-yellow-500 p-2 rounded-full shadow-lg border-2 border-white">
                                <Home size={24} />
                            </div>
                            <span className="text-[10px] font-bold mt-1 bg-slate-900 px-2 rounded text-yellow-400">HOUSE</span>
                            </div>
                        )}
                        
                        {cell.type === 'end' && (
                            <div className="flex flex-col items-center justify-center text-white z-10">
                            <div className="bg-blue-600 p-2 rounded-full shadow-lg border-2 border-white">
                                <Factory size={24} />
                            </div>
                            <span className="text-[10px] font-bold mt-1 bg-slate-900 px-2 rounded text-blue-300">PLANT</span>
                            </div>
                        )}

                        {cell.type === 'pipe' && renderPipe(cell)}
                        
                        {cell.type === 'pipe' && gameState === 'playing' && (
                            <div className="absolute inset-0 flex items-center justify-center opacity-0 hover:opacity-100 pointer-events-none">
                            <RotateCw className="text-white drop-shadow-md" size={20} />
                            </div>
                        )}
                        </div>
                    ))}
                    </div>

                    <div className="mt-4 flex gap-4 justify-center text-slate-400 text-xs font-mono">
                    <div className="flex items-center gap-2">
                        <div className="w-3 h-3 bg-slate-700 rounded"></div> Pipe
                    </div>
                    <div className="flex items-center gap-2">
                        <div className="w-3 h-3 bg-blue-500 rounded"></div> Water
                    </div>
                    <div className="flex items-center gap-2">
                        <div className="w-3 h-3 bg-yellow-500 rounded"></div> Origin
                    </div>
                    </div>
                </Card>

                <div className="mt-8 h-20">
                    {gameState === 'playing' && (
                    <Button onClick={checkSystem} className="w-full shadow-xl animate-bounce-slight">
                        TEST CONNECTION
                    </Button>
                    )}
                    
                    {gameState === 'flowing' && (
                    <div className="text-blue-600 font-bold text-xl flex items-center gap-3 bg-white px-6 py-3 rounded-full shadow-md">
                        <Droplet className="animate-bounce" fill="currentColor" size={24} />
                        FLOWING... {flowProgress}%
                    </div>
                    )}

                    {gameState === 'success' && (
                    <Button onClick={nextLevel} className="bg-green-500 hover:bg-green-400 text-white border-green-700">
                        NEXT LEVEL <ArrowRight size={20} />
                    </Button>
                    )}
                </div>

                <div className="mt-6 max-w-md text-center bg-white/80 p-4 rounded-xl backdrop-blur-sm border border-slate-200">
                    <h3 className="font-bold text-slate-700 mb-1">Did you know?</h3>
                    <p className="text-sm text-slate-600">
                    Under the street, pipes work like highways! The <strong>Sewer Main</strong> is like a big highway for water to travel to the cleaning plant.
                    </p>
                </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SewerSystemGame />);
    </script>
</body>
</html>
